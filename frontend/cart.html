<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/index.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <title>Cart</title>
  </head>
  <script src="/scripts/navbar.js"></script>
  <body>
    <div id="cart-container">
      <p class="fs-2 fw-semibold">Cart</p>
      <div id="cart-inner-container">
        <div id="cart-items" class="p-4 mb-3 border border-danger scrollable-container"></div>
      </div>
      <div id="cart-total"></div>
      <div id="buy-now-btn-cart">Buy Now</div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      //navbar
      const body = document.body;
      let user;

      //Authenticating
      fetch(`${process.env.BACKEND_BASE_URL}/user/verify`, {
        credentials: "include",
      })
        .then((res) => res.json())
        .then((res) => {
          if(!res.success) {
            window.location.href="/user/login";
          }
          user = res.user;

          //fetch cart
          fetch(`${process.env.BACKEND_BASE_URL}/cart/getCart`, {
            credentials: "include",
          })
            .then((res) => {
              return res.json();
            })
            .then((res) => {
              displayCartItems(res.items);
            })
            .then((res => {
              const buyNowBtn = document.getElementById("buy-now-btn-cart");
              buyNowBtn.addEventListener("click", () => {
                window.location.href=`${process.env.FRONTEND_BASE_URL}/cart/checkout/?mode=cart`;
              });
            }))
        })
        .catch((error) => {
          document.getElementById("cart-container").innerHTML = `
            <h3>An error occured</h3> 
            <h5>Error in Authentication</h5>
            <h4>${error}</h4>
            <a href="${process.env.FRONTEND_BASE_URL}/home">Click to go to Homepage</a>
            `;
        });

      function displayCartItems(items) {
        if(items.length == 0) {
          document.getElementById("cart-container").innerHTML = "<h1>Nothing to show in cart.</h1>";
        }
        let finalTotal = 0;
        const cartItems = document.getElementById("cart-items");
        cartItems.innerHTML = ``;

        if(items.length == 0) {
          cartItems.innerHTML = `<h4>Nothing to show in cart</h4>`;
          return;
        }
        items.forEach((item) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "item-cart";
          itemDiv.classList.add(
            "card",
            "p-4",
            "mb-3",
            "border",
            "border-secondary"
          );

          if(item.stock > 0) {
              itemDiv.innerHTML = `
              <div class="row g-0">
                <div class="col-md-4 product-image-container-cart">
                    <img src="${item.images[0].url}" class="card-img-top product-image" alt="product-image">
                </div>
                      <div class="col-md-8">
                        <div class="card-body">
                          <h5 class="card-title"><a href="${process.env.FRONTEND_BASE_URL}/product/?id=${item.productId}">${item.name}</a></h5>
                          <div class="quantity-container">
                            <div class="btn-quantity" onclick="decreasQuantity('${item.productId}')">-</div>
                            <div class="btn-quantity-text">${item.quantity}</div>
                            <div class="btn-quantity" onclick="increaseQuantity('${item.productId}')" id="btn-quantity-add">+</div>
                          </div>
                          <span class="fs-5 fw-bold">Price: â‚¹${(item.price * item.quantity).toFixed(2)}</span>
                          <p class="card-text">Stock: ${item.stock}</p>
                        </div>
                      </div>
              </div>
            `;
            let itemPrice = item.price;
            finalTotal = finalTotal + item.price*item.quantity;
            finalTotal = Number(finalTotal.toFixed(2));

            if(item.shippingCharges == 0) {
              const shippingText = document.createElement("p");
              shippingText.classList.add("card-text");
              shippingText.innerText = `Free Shipping`;
              itemDiv.appendChild(shippingText);
            }
          }
          else {
            itemDiv.innerHTML = `
              <div class="row g-0">
                <div class="col-md-4 product-image-container">
                    <img src="${item.images[0].url}" class="card-img-top product-image" alt="product-image" width:"1000px">
                </div>
                      <div class="col-md-8">
                        <div class="card-body">
                          <h5 class="card-title">${item.name}</h5>
                            <div class="quantity-container">
                              <div class="btn-quantity" onclick="decreasQuantity('${item.productId}')">-</div>
                              <div class="btn-quantity-text">${item.quantity}</div>
                              <div class="btn-quantity" onclick="increaseQuantity('${item.productId}')" id="btn-quantity-add">+</div>
                            </div>
                          <span class="fs-5 fw-bold" >Price: $${item.price}</span>
                          <p class="fs-5 fw-semibold" >Item is out of stock</p>
                        </div>
                      </div>
              </div>
            `;
          }
          cartItems.appendChild(itemDiv);
        });

        const cartTotal = document.getElementById("cart-total");
        cartTotal.innerHTML = `
        <p class=fs-4>Total: ${finalTotal.toFixed(2)}</p>
        `;
      }

      function increaseQuantity(productId) {
        fetch(`${process.env.BACKEND_BASE_URL}/cart/addItem/${productId}`, {
          credentials: 'include', 
          method:'POST'
        })
        .then(() => {
          window.location.reload();
        })
        .catch((err) => {
          console.log("Error at increaseQuantity: ", err);
        });
      }

      function decreasQuantity(productId) {
        fetch(`${process.env.BACKEND_BASE_URL}/cart/removeItem/${productId}`, {credentials: 'include', method:'POST'})
        .then(() => {
          window.location.reload();
        })
        .catch((err) => {
          console.log("Error at decreaseQuantity: ", err);
        });
      }
    </script>
  </body>
</html>
